---
name: aiwg-regenerate-claude
description: Regenerate CLAUDE.md for Claude Code with intelligent content preservation
args: "[--no-backup] [--dry-run] [--full]"
---

# Regenerate CLAUDE.md

Regenerate the CLAUDE.md file for Claude Code integration. This command performs an **intelligent merge** - analyzing the current project state while preserving team-written content.

## Core Principle

**Team content is preserved. AIWG content is updated.**

The agent must distinguish between:
- **Team content**: Project rules, conventions, requirements, decisions written by humans
- **AIWG content**: Framework integration, agent definitions, reference links generated by AIWG

## Parameters

| Flag | Description |
|------|-------------|
| `--no-backup` | Skip creating backup file |
| `--dry-run` | Preview changes without writing |
| `--full` | Full regeneration - replaces everything (destructive) |

## Execution Steps

### Step 1: Create Backup

Unless `--no-backup` specified:

1. Check if `CLAUDE.md` exists
2. If exists, copy to `CLAUDE.md.backup-{YYYYMMDD-HHMMSS}`
3. Report: `Backup created: CLAUDE.md.backup-20251206-152233`

If no existing file, skip backup and note: `No existing CLAUDE.md found, generating fresh.`

### Step 2: Analyze Existing Content

If existing CLAUDE.md present (and not `--full`):

**Read the file and intelligently categorize each section:**

**Team Content (PRESERVE):**
- Project-specific coding standards and conventions
- API guidelines and architectural decisions
- Security policies and compliance requirements
- Team workflows and processes
- Business rules and constraints
- Definition of Done criteria
- Historical context and rationale
- Any content that reflects human decisions about the project

**AIWG Content (UPDATE):**
- AIWG Integration sections
- Agent definitions and listings
- Command listings
- @-mention reference tables
- Orchestration instructions
- Framework version information
- Auto-detected project info (tech stack, commands)

**Identification Heuristics:**
- Team content often uses first-person ("we", "our team")
- Team content references specific business/domain terms
- Team content contains opinions, preferences, rationale
- AIWG content references `~/.local/share/ai-writing-guide`
- AIWG content has structured @-mention tables
- AIWG content lists agents, commands, frameworks

### Step 3: Analyze Project

**Detect Languages & Package Managers:**

Use Glob to find package files:
```
package.json → Node.js/npm
pyproject.toml / requirements.txt → Python
go.mod → Go
Cargo.toml → Rust
pom.xml / build.gradle → Java
composer.json → PHP
Gemfile → Ruby
```

**Extract Development Commands:**

From `package.json`:
```json
{
  "scripts": {
    "build": "tsc",
    "test": "vitest",
    "lint": "eslint ."
  }
}
```

From `Makefile`:
```makefile
build:
    go build ./...

test:
    go test ./...
```

**Detect Test Framework:**

| File Pattern | Framework |
|--------------|-----------|
| `jest.config.*` | Jest |
| `vitest.config.*` | Vitest |
| `pytest.ini`, `conftest.py` | Pytest |
| `*_test.go` | Go testing |
| `.rspec` | RSpec |
| `phpunit.xml` | PHPUnit |

**Detect CI/CD:**

| Path | Platform |
|------|----------|
| `.github/workflows/*.yml` | GitHub Actions |
| `.gitlab-ci.yml` | GitLab CI |
| `Jenkinsfile` | Jenkins |
| `.circleci/config.yml` | CircleCI |
| `azure-pipelines.yml` | Azure DevOps |

**Extract Project Description:**

Read first meaningful paragraph from `README.md` or `description` from `package.json`.

**Analyze Directory Structure:**

```
src/ or lib/ → Source code
test/ or tests/ or __tests__/ → Tests
docs/ → Documentation
scripts/ or tools/ → Tooling
.github/ → GitHub configuration
```

### Step 4: Detect AIWG State

**Check for installed frameworks:**

1. Read `.aiwg/frameworks/registry.json` if exists
2. Scan `.claude/agents/` for deployed agents
3. Scan `.claude/commands/` for deployed commands
4. Read `~/.local/share/ai-writing-guide/registry.json` for global state

**Identify active frameworks:**
- Count agent files matching sdlc-complete patterns
- Count command files matching sdlc-complete patterns
- Detect aiwg-utils presence
- Detect media-marketing-kit presence

**Check Claude-specific config:**

Read `.claude/settings.local.json` if exists for:
- Allowed read paths
- Allowed write paths
- Allowed bash commands

### Step 5: Generate CLAUDE.md

**Document Structure:**

```markdown
# CLAUDE.md

This file provides guidance to Claude Code when working with this codebase.

## Repository Purpose

{First paragraph from README.md or package.json description}

## Tech Stack

- **Languages**: {detected languages}
- **Runtime**: {Node.js version, Python version, etc.}
- **Package Manager**: {npm, yarn, pip, etc.}
- **Framework**: {React, FastAPI, etc. if detected}
- **Database**: {if detected from dependencies}

## Development Commands

```bash
# {grouped by purpose}
{extracted commands with descriptions}
```

## Testing

- **Framework**: {detected framework}
- **Run tests**: `{test command}`
- **Coverage**: `{coverage command if found}`
- **Location**: `{test directory}`

## Architecture

{Description based on directory structure}

### Directory Structure

```
{key directories with descriptions}
```

## Important Files

- `{file}` - {purpose}
{repeat for key files}

## Configuration

{List of config files and their purpose}

---

{INSERT ALL TEAM CONTENT HERE - EXACTLY AS FOUND}

{If team content exists, preserve it verbatim in its original location/order}

---

## Project Artifacts

{If .aiwg/ directory exists, wire up project-specific docs:}

| Category | Location |
|----------|----------|
| Requirements | @.aiwg/requirements/ |
| Architecture | @.aiwg/architecture/ |
| Planning | @.aiwg/planning/ |
| Testing | @.aiwg/testing/ |
| Security | @.aiwg/security/ |

{Only include rows for directories that exist}

{ENHANCEMENT: Add @-mentions below team sections to link with AIWG resources}
{Example: If team has "Security Requirements" section, add below it:}
{Related: @.aiwg/security/, /flow-security-review-cycle, /flow-compliance-validation}

---

## AIWG Integration

AIWG is installed at: `~/.local/share/ai-writing-guide`

### Installed Components

| Component | Type | Count |
|-----------|------|-------|
{table of installed frameworks, addons - only if any installed}

### Available Agents

{List of deployed agents from .claude/agents/ - brief descriptions}

### Available Commands

{List of deployed commands from .claude/commands/ - organized by category}

### Orchestration

You are the Core Orchestrator. When users request workflows:

1. Interpret natural language requests
2. Map to appropriate flow commands
3. Coordinate multi-agent workflows
4. Report progress with clear indicators

### Core References

Use @-mentions to load guidance as needed:

| Topic | Reference |
|-------|-----------|
| Orchestration | @~/.local/share/ai-writing-guide/agentic/code/addons/aiwg-utils/prompts/core/orchestrator.md |
| Agent Design | @~/.local/share/ai-writing-guide/agentic/code/addons/aiwg-utils/prompts/agents/design-rules.md |
| Error Recovery | @~/.local/share/ai-writing-guide/agentic/code/addons/aiwg-utils/prompts/reliability/resilience.md |

{If SDLC framework installed, add:}

### SDLC Framework References

| Topic | Reference |
|-------|-----------|
| Natural Language | @~/.local/share/ai-writing-guide/agentic/code/frameworks/sdlc-complete/docs/simple-language-translations.md |
| Orchestration | @~/.local/share/ai-writing-guide/agentic/code/frameworks/sdlc-complete/docs/orchestrator-architecture.md |

{If Marketing framework installed, add similar section}
```

### Step 6: Write Output

**If `--dry-run`:**
Display the generated content, do not write.

**Otherwise:**
1. Write generated content to `CLAUDE.md`
2. Verify write succeeded
3. Report summary

```
CLAUDE.md Regenerated
=====================

Backup: CLAUDE.md.backup-20251206-152233

Team Content Preserved:
  ✓ Team Conventions (18 lines)
  ✓ Definition of Done (9 lines)
  ✓ Security Requirements (7 lines)
  ✓ API Guidelines (12 lines)

AIWG Content Updated:
  ✓ Tech Stack (TypeScript, Node.js 18+)
  ✓ Development Commands (12 scripts)
  ✓ Testing (Vitest)
  ✓ Project Artifacts (@-mentions)
  ✓ AIWG Integration
    - sdlc-complete (54 agents, 42 commands)
    - aiwg-utils (core utilities)

Enhancements Added:
  ✓ Linked Security Requirements → flow-security-review-cycle
  ✓ Linked API Guidelines → architecture docs

Output: CLAUDE.md (428 lines, 18,234 bytes)
```

## Content Enhancement

When preserving team content, the agent MAY add helpful @-mentions and links below team sections **without modifying the team's words**.

**Example:**

Team wrote:
```markdown
## Security Requirements

- Must comply with SOC2
- All data encrypted at rest
- Quarterly penetration testing
```

Agent enhances:
```markdown
## Security Requirements

- Must comply with SOC2
- All data encrypted at rest
- Quarterly penetration testing

Related: /flow-security-review-cycle, /flow-compliance-validation SOC2, @.aiwg/security/
```

The team's content is **untouched**. Links are added below.

## Updating Outdated Information

The agent MAY update genuinely outdated information:
- Version numbers that are clearly stale
- References to files that no longer exist
- Deprecated patterns with official replacements

The agent **MUST NOT** change:
- Team opinions or preferences
- Architectural decisions (even if the agent disagrees)
- Business requirements
- Process decisions

## Examples

```bash
# Regenerate CLAUDE.md with intelligent preservation
/aiwg-regenerate-claude

# Preview without writing
/aiwg-regenerate-claude --dry-run

# Full regeneration (replaces everything)
/aiwg-regenerate-claude --full

# Skip backup (use carefully)
/aiwg-regenerate-claude --no-backup
```

## Error Handling

| Condition | Action |
|-----------|--------|
| No CLAUDE.md exists | Generate fresh document |
| Backup fails | Abort, report error |
| Read error | Report error, suggest --full |
| No AIWG detected | Generate project-only content, warn |
| No package files | Generate minimal structure, warn |
| Ambiguous content | Preserve it (err on side of caution) |

## Notes

- This command is Claude Code specific
- For Warp Terminal, use `/aiwg-regenerate-warp`
- For Factory AI, use `/aiwg-regenerate-factory`
- For auto-detection, use `/aiwg-regenerate`
