# Build and package Claude Code plugins
# Triggers on release or manual dispatch
#
# @implements @.aiwg/architecture/decisions/ADR-016-claude-code-plugin-distribution.md

name: Build Plugins

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      clean:
        description: 'Clean plugins directory before building'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Package plugins
        run: |
          if [ "${{ github.event.inputs.clean }}" = "true" ] || [ "${{ github.event_name }}" = "release" ]; then
            npm run package-plugins:clean
          else
            npm run package-plugins
          fi

      - name: Validate plugin manifests
        run: |
          echo "Validating plugin manifests..."
          for plugin in plugins/*/; do
            if [ -f "$plugin.claude-plugin/plugin.json" ]; then
              echo "✓ $(basename $plugin): manifest valid"
              cat "$plugin.claude-plugin/plugin.json" | head -5
            else
              echo "✗ $(basename $plugin): missing manifest"
              exit 1
            fi
          done

      - name: Validate marketplace.json
        run: |
          echo "Validating marketplace.json..."
          if [ -f "plugins/.claude-plugin/marketplace.json" ]; then
            echo "✓ marketplace.json exists"
            cat "plugins/.claude-plugin/marketplace.json" | head -20
          else
            echo "✗ marketplace.json missing"
            exit 1
          fi

      - name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aiwg-plugins-${{ github.sha }}
          path: plugins/
          retention-days: 30

      - name: Commit plugins (release only)
        if: github.event_name == 'release'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet plugins/; then
            echo "No changes to plugins"
          else
            git add plugins/
            git commit -m "build: package plugins for ${{ github.event.release.tag_name }}"
            git push
          fi

  # Notify about plugin availability
  notify:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Create plugin release notes
        run: |
          echo "## Claude Code Plugins Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Plugins are now available for Claude Code installation:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "/plugin marketplace add jmagly/ai-writing-guide" >> $GITHUB_STEP_SUMMARY
          echo "/plugin install sdlc@aiwg" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Plugins" >> $GITHUB_STEP_SUMMARY
          echo "- **sdlc**: SDLC Complete (58 agents)" >> $GITHUB_STEP_SUMMARY
          echo "- **marketing**: Marketing Kit (37 agents)" >> $GITHUB_STEP_SUMMARY
          echo "- **voice**: Voice Framework" >> $GITHUB_STEP_SUMMARY
          echo "- **writing**: Writing Quality" >> $GITHUB_STEP_SUMMARY
          echo "- **utils**: Core Utilities" >> $GITHUB_STEP_SUMMARY
          echo "- **hooks**: Workflow Hooks" >> $GITHUB_STEP_SUMMARY
