# ADR-001: WARP.md File Structure Decision

## Status
**Proposed** (Pending Warp team validation)

## Context

The AI Writing Guide (AIWG) framework currently supports two AI provider platforms:
- **Claude**: Deploys to `.claude/agents/` and `.claude/commands/` directories
- **OpenAI**: Deploys to `.codex/agents/` and `.codex/commands/` directories (with optional AGENTS.md aggregation)

We need to integrate Warp AI as a third provider platform. Warp AI uses a different configuration approach:
- Expects a single `WARP.md` file in the project root
- Does not have an established directory structure convention (no `.warp/` pattern)
- Combines all project rules, context, and instructions in one markdown file

### Current Deployment Patterns

1. **Directory-based** (Claude/OpenAI default):
   - Individual agent files in `.[provider]/agents/`
   - Separate command files in `.[provider]/commands/`
   - Allows selective updates and granular management

2. **Single-file** (OpenAI with --as-agents-md):
   - All agents aggregated into `AGENTS.md`
   - Commands remain separate
   - Better for platforms preferring consolidated configuration

### Requirements

- Must integrate cleanly with existing deploy-agents.mjs architecture
- Should follow Warp platform conventions and expectations
- Needs to support both general and SDLC deployment modes
- Must handle 50+ agents and 40+ commands efficiently
- Should enable version control and diff tracking

## Decision

**Deploy Warp configuration as a single `WARP.md` file in the project root.**

### Chosen Structure

```
project-root/
├── WARP.md                   # All Warp configuration
├── .claude/                  # Claude agents/commands
│   ├── agents/
│   └── commands/
└── .codex/                   # OpenAI agents/commands
    ├── agents/
    └── commands/
```

### WARP.md Internal Structure

```markdown
# WARP Project Configuration

## Metadata
- Generated by: AI Writing Guide v[version]
- Generated at: [timestamp]
- Deployment mode: [general|sdlc|both]

## Project Context
[Extracted from CLAUDE.md if available]

## Agent Rules
[Each agent transformed to a rule section]

## Commands
[Each command transformed to instruction section]

## Custom Sections
[Preserved between deployments if marked]
```

## Consequences

### Positive Consequences

1. **Platform Alignment**: Matches Warp's expected single-file configuration model
2. **Simplicity**: One file to manage, review, and version control
3. **Discoverability**: WARP.md in root is immediately visible to users
4. **Atomic Updates**: Entire configuration updated at once, no partial states
5. **Diff-Friendly**: Single file makes reviewing changes straightforward
6. **No Directory Pollution**: Avoids creating another hidden directory
7. **Consistency**: Similar to OpenAI's AGENTS.md aggregation approach

### Negative Consequences

1. **File Size**: With 50+ agents, WARP.md could exceed 10,000 lines
2. **Merge Conflicts**: Single file increases likelihood of git conflicts
3. **No Selective Updates**: Can't update single agent without regenerating entire file
4. **Performance**: Must read/write entire file even for small changes
5. **Organization**: Harder to navigate than directory structure
6. **No Modularity**: Can't selectively include/exclude agents

### Mitigation Strategies

1. **File Size**:
   - Implement content folding markers for editors
   - Add table of contents generation
   - Support `--mode` filtering (general/sdlc/both)

2. **Merge Conflicts**:
   - Sort sections deterministically
   - Use consistent formatting
   - Add merge driver configuration

3. **Navigation**:
   - Generate index at top of file
   - Use consistent heading structure
   - Add search-friendly markers

## Alternatives Considered

### Alternative 1: .warp/ Directory Structure

```
.warp/
├── agents/
│   ├── architecture-designer.md
│   ├── security-architect.md
│   └── ...
├── commands/
│   ├── flow-inception.md
│   └── ...
└── config.md
```

**Rejected because**:
- Warp platform doesn't support multi-file configuration
- Would require Warp to change their file discovery mechanism
- Inconsistent with Warp's design philosophy

### Alternative 2: Multiple WARP Files

```
WARP-agents.md
WARP-commands.md
WARP-config.md
```

**Rejected because**:
- Warp expects single WARP.md file
- Complicates file discovery
- Requires coordination between multiple files
- No clear benefit over single file

### Alternative 3: Embedded Sections in Existing Files

```
# In .claude/agents/[agent].md files
<!-- WARP:BEGIN -->
[Warp-specific configuration]
<!-- WARP:END -->
```

**Rejected because**:
- Pollutes Claude/OpenAI agent files
- Requires parsing multiple files to build WARP.md
- Increases complexity significantly
- Violates separation of concerns

### Alternative 4: JSON or YAML Configuration

```
warp-config.json
{
  "agents": [...],
  "commands": [...],
  "context": "..."
}
```

**Rejected because**:
- Warp expects markdown format
- Less readable than markdown
- Requires additional transformation step
- Inconsistent with platform conventions

## Implementation Notes

### Generation Strategy

1. **Collection Phase**:
   - Gather all agent files based on mode (general/sdlc/both)
   - Collect all command files if --deploy-commands specified

2. **Transformation Phase**:
   - Convert each agent to Warp rule format
   - Transform commands to instruction format
   - Extract project context from CLAUDE.md

3. **Aggregation Phase**:
   - Sort sections for deterministic output
   - Combine into single markdown structure
   - Add metadata and navigation aids

4. **Write Phase**:
   - Compare with existing WARP.md if present
   - Preserve custom sections if marked
   - Write atomic update

### Code Location

```javascript
// tools/agents/deploy-agents.mjs
if (provider === 'warp') {
  const warpContent = await generateWarpMd(files, options);
  await fs.writeFile(path.join(target, 'WARP.md'), warpContent);
}
```

### Custom Section Preservation

Support special markers for user customization:

```markdown
<!-- WARP:CUSTOM:BEGIN -->
User's custom content preserved between deployments
<!-- WARP:CUSTOM:END -->
```

## Related Decisions

- **ADR-002**: Agent Transformation Strategy (how to convert agents to rules)
- **ADR-003**: Command Representation in Warp (how to express commands)
- **ADR-004**: Model Mapping for Warp (handling lack of model selection)

## References

- [Warp AI Documentation](https://warp.ai/docs)
- [AIWG deploy-agents.mjs](../../tools/agents/deploy-agents.mjs)
- [OpenAI AGENTS.md approach](../../agents/openai-compat.md)

## Review History

- 2024-12-20: Initial draft created
- Pending: Warp team review and validation
- Pending: Implementation proof of concept
- Pending: User acceptance testing

---

**Document Version**: 1.0.0
**Decision Date**: 2024-12-20
**Decision Makers**: AIWG Architecture Team
**Review Status**: Awaiting Validation