# Prompt Reinforcement Configuration
# Agent Persistence Framework - UC-AP-005
# Created: 2026-02-02

prompt_reinforcement:
  enabled: true
  default_intensity: STANDARD

  # Graduated escalation based on iteration count (per REF-015 Self-Refine)
  # Quality peaks at iteration 2-3, degrades later - escalate intensity accordingly
  intensity_escalation:
    iteration_1_3: MINIMAL     # Trust agent, light reminders
    iteration_4_6: STANDARD    # Normal anti-laziness prompts
    iteration_7_9: AGGRESSIVE  # Strong constraints, explicit warnings
    iteration_10_plus: ADAPTIVE # Dynamic + human checkpoint

  # Risk patterns that trigger specific intensities
  risk_patterns:
    test_file_modification:
      pattern: "**/test/**/*.{ts,js,py,java,go,rb,php}"
      actions: [write, delete]
      escalate_to: AGGRESSIVE
      reason: "Modifying tests is high-risk - may indicate test deletion/weakening"

    coverage_regression:
      threshold: -5  # Percent decrease triggers intervention
      action: IMMEDIATE_INTERVENTION
      escalate_to: AGGRESSIVE
      reason: "Coverage regression indicates possible test deletion or feature removal"

    test_count_decrease:
      threshold: -1  # Any decrease triggers intervention
      action: IMMEDIATE_INTERVENTION
      escalate_to: AGGRESSIVE
      reason: "Test count decrease is clear signal of test deletion"

    error_repetition:
      threshold: 3  # Same error 3 times
      escalate_to: STANDARD
      reason: "Repeated errors indicate stuck loop or incorrect approach"

    stuck_loop:
      iteration_threshold: 5
      escalate_to: AGGRESSIVE
      reason: "High iteration count indicates stuck loop - escalation needed"

    feature_disabling:
      patterns:
        - "//.*DISABLED"
        - "/*.*DISABLED.**/"
        - "#.*DISABLED"
        - ".skip\\("
        - ".todo\\("
        - "@Ignore"
        - "@Disabled"
      action: IMMEDIATE_INTERVENTION
      escalate_to: AGGRESSIVE
      reason: "Feature disabling is destructive avoidance behavior"

  # Context budget limits to preserve agent context window
  context_budget:
    max_tokens_per_injection: 150
    max_total_tokens_per_session: 500
    reserve_context_window: 2000  # Tokens to always preserve for agent
    warn_at_percentage: 80  # Warn when context window 80% full

  # Injection point enablement
  injection_points:
    session_init:
      enabled: true
      max_tokens: 50
      applies_to: [software-implementer, test-engineer, debugger]

    pre_tool_call:
      enabled: true
      max_tokens: 100
      triggers:
        - tool: Write
          file_patterns: ["**/test/**", "**/src/**"]
        - tool: Edit
          file_patterns: ["**/test/**"]
      applies_to: [software-implementer, debugger]

    post_error:
      enabled: true
      max_tokens: 150
      error_types: [test_failure, build_error, runtime_error, type_error]
      applies_to: [software-implementer, test-engineer, debugger]

    iteration_boundary:
      enabled: true
      max_tokens: 100
      thresholds: [3, 5, 7, 10]
      applies_to: [software-implementer, test-engineer, debugger]

    regression_detected:
      enabled: true
      max_tokens: 300  # Allow more for critical intervention
      regression_types: [test_count, coverage, feature_count]
      applies_to: [software-implementer, test-engineer, debugger, code-reviewer]

    pre_commit:
      enabled: true
      max_tokens: 150
      applies_to: [software-implementer, test-engineer, debugger]

  # Directive library (templates referenced by agents)
  directive_library:
    core:
      never_delete_tests: "NEVER delete or disable tests - FIX the underlying code. Tests reveal bugs; removing them hides bugs."
      root_cause_first: "If tests fail, diagnose the root cause before any code changes. Symptom treatment creates technical debt."
      no_feature_removal: "Removing features is NOT a valid fix for bugs. Fix the feature, don't eliminate it."
      escalate_when_stuck: "If you cannot solve after 3 attempts, ESCALATE. Do not take shortcuts to force completion."
      tests_are_allies: "Tests are your allies, not obstacles to remove. They protect against regressions."

  # Audit and metrics
  audit:
    log_all_injections: true
    log_path: ".aiwg/ralph/reinforcement-logs/"
    log_format: "yaml"
    track_effectiveness: true
    retention_days: 90

  # A/B testing support (for measuring effectiveness)
  ab_testing:
    enabled: false  # Enable for controlled experiments
    control_percentage: 50  # % of sessions without reinforcement
    metrics:
      - avoidance_behavior_rate
      - escalation_rate
      - task_success_rate
      - iteration_count
      - time_to_completion
    minimum_sample_size: 100  # Per group

  # Effectiveness tracking
  metrics:
    track:
      - avoidance_behavior_rate
      - test_deletion_incidents
      - feature_disabling_rate
      - escalation_rate
      - task_success_rate
      - mean_iterations_to_success

    targets:
      avoidance_behavior_rate: 0.15  # <15%
      test_deletion_incidents: 0.05  # <5%
      feature_disabling_rate: 0.10   # <10%
      escalation_rate: 0.20          # 15-25%
      task_success_rate: 0.80        # >80%
      mean_iterations_to_success: 4  # <4 iterations

    baselines:
      avoidance_behavior_rate: 0.50  # ~40-60% from research
      escalation_rate: 0.05          # Current low escalation

  # Adaptive mode configuration (ML-enhanced)
  adaptive:
    enabled: false  # Enable when ML model available
    model_path: ".aiwg/models/reinforcement-adaptive.pkl"
    features:
      - iteration_count
      - error_type
      - error_repetition_count
      - files_modified_count
      - agent_type
      - task_complexity
    update_frequency: "weekly"  # Retrain model weekly

# References:
# - @.aiwg/architecture/decisions/ADR-AP-003-prompt-injection-points.md
# - @.aiwg/requirements/use-cases/UC-AP-005-prompt-reinforcement.md
# - @.aiwg/research/findings/agentic-laziness-research.md
# - @docs/references/REF-015-self-refine-iterative-refinement.md
