# Workflow Checkpoint Schema
# Based on REF-058 R-LAM (systematic checkpoint/recovery)
# Issue: #112

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://aiwg.io/schemas/checkpoint/v1"
title: "Workflow Checkpoint Schema"
description: |
  Systematic checkpoint and recovery for workflows to enable resumption
  from last good state after failures. Based on R-LAM findings.

type: object
required:
  - checkpoint_id
  - workflow_id
  - created_at
  - state

properties:
  checkpoint_id:
    type: string
    format: uuid
    description: "Unique checkpoint identifier"

  workflow_id:
    type: string
    description: "ID of the workflow being checkpointed"

  workflow_type:
    type: string
    enum:
      - ralph_loop
      - flow_command
      - skill_execution
      - agent_task
    description: "Type of workflow"

  created_at:
    type: string
    format: date-time
    description: "When checkpoint was created"

  trigger:
    type: string
    enum:
      - manual           # User-initiated
      - automatic        # System-initiated
      - phase_boundary   # At phase transition
      - iteration        # At Ralph iteration
      - pre_risky_op     # Before risky operation
      - error_recovery   # During error recovery
    description: "What triggered the checkpoint"

  state:
    type: object
    required: [phase, progress, artifacts]
    description: "Complete workflow state"
    properties:
      phase:
        type: string
        description: "Current SDLC phase"

      step:
        type: string
        description: "Current step within phase"

      progress:
        type: object
        properties:
          total_steps:
            type: integer
          completed_steps:
            type: integer
          percentage:
            type: number
            minimum: 0
            maximum: 100
        description: "Progress tracking"

      iteration:
        type: object
        properties:
          current:
            type: integer
          max:
            type: integer
          failures:
            type: integer
        description: "Ralph iteration state (if applicable)"

      artifacts:
        type: array
        items:
          type: object
          properties:
            path:
              type: string
            hash:
              type: string
            status:
              type: string
              enum: [created, modified, deleted, unchanged]
        description: "Artifact state at checkpoint"

      variables:
        type: object
        additionalProperties: true
        description: "Workflow variables and context"

      agent_state:
        type: object
        properties:
          current_agent:
            type: string
          memory:
            type: object
          pending_actions:
            type: array
            items:
              type: string
        description: "Agent execution state"

  execution_config:
    $ref: "#/$defs/ExecutionConfig"
    description: "Configuration for reproducibility"

  metadata:
    type: object
    properties:
      size_bytes:
        type: integer
      compression:
        type: string
        enum: [none, gzip, lz4]
      retention_days:
        type: integer
        default: 30
      tags:
        type: array
        items:
          type: string
    description: "Checkpoint metadata"

$defs:
  ExecutionConfig:
    type: object
    description: "Configuration snapshot for reproducibility"
    properties:
      model:
        type: string
        description: "Model ID (e.g., claude-3-opus)"
      temperature:
        type: number
        minimum: 0
        maximum: 2
      seed:
        type: integer
        description: "Random seed if set"
      execution_mode:
        type: string
        enum: [strict, seeded, logged, default]
      agent:
        type: string
        description: "Active agent"
      tools:
        type: array
        items:
          type: string
        description: "Available tools"
      inputs:
        type: object
        additionalProperties: true
        description: "Input values"

# Recovery configuration
recovery:
  strategies:
    last_checkpoint:
      description: "Restore most recent checkpoint"
      steps:
        - load_checkpoint
        - restore_state
        - resume_execution

    select_checkpoint:
      description: "Let user choose checkpoint"
      steps:
        - list_checkpoints
        - user_selects
        - load_checkpoint
        - restore_state
        - resume_execution

    smart_rollback:
      description: "Analyze and select best checkpoint"
      steps:
        - analyze_failure
        - find_safe_checkpoint
        - load_checkpoint
        - restore_state
        - resume_execution

  restore_sequence:
    - validate_checkpoint_integrity
    - restore_artifacts
    - restore_variables
    - restore_agent_state
    - verify_state
    - resume_or_fail

# Checkpoint lifecycle
lifecycle:
  creation:
    auto_triggers:
      - phase_start
      - artifact_complete
      - before_external_call
      - iteration_boundary

  retention:
    default_count: 5
    default_days: 30
    on_success: keep_latest
    on_failure: keep_all_recent

  cleanup:
    schedule: daily
    preserve_tagged: true
    compress_old: true

# Storage configuration
storage:
  location: ".aiwg/checkpoints/"
  format: json
  compression: gzip
  naming: "{workflow_id}-{timestamp}-{trigger}.json.gz"

# Example checkpoint
examples:
  - checkpoint_id: "cp-001-example"
    workflow_id: "ralph-research-impl"
    workflow_type: ralph_loop
    created_at: "2026-01-25T15:00:00Z"
    trigger: iteration
    state:
      phase: construction
      step: implement_issue
      progress:
        total_steps: 10
        completed_steps: 3
        percentage: 30
      iteration:
        current: 5
        max: 200
        failures: 0
      artifacts:
        - path: ".aiwg/research/schemas/checkpoint.yaml"
          hash: "abc123..."
          status: created
      variables:
        current_issue: "#112"
        implementation_approach: "agentic"
    execution_config:
      model: "claude-3-opus"
      temperature: 0
      execution_mode: strict
      agent: "Software Implementer"
    metadata:
      size_bytes: 4096
      compression: gzip
      retention_days: 30

# References
references:
  research:
    - "@.aiwg/research/findings/REF-058-r-lam.md"
  implementation:
    - "#112"
  related:
    - "@.aiwg/flows/schemas/error-handling.yaml"
    - "@.aiwg/ralph/schemas/reflection-memory.json"
